<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Jeff Hill Realty</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#7aaa6d',
            accent: '#5a8f4e',
          }
        }
      }
    }
  </script>
  <style>
    .ql-editor {
      min-height: 300px;
    }
    /* Make images in editor resizable and floatable */
    .ql-editor img {
      max-width: 100%;
      cursor: pointer;
      margin: 8px 0;
    }
    .ql-editor img.float-left {
      float: left;
      margin: 0 16px 8px 0;
      max-width: 50%;
    }
    .ql-editor img.float-right {
      float: right;
      margin: 0 0 8px 16px;
      max-width: 50%;
    }
    .ql-editor img.small {
      max-width: 200px;
    }
    .ql-editor img.medium {
      max-width: 350px;
    }
    /* Image options menu */
    #img-menu {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 8px;
      z-index: 1000;
      display: none;
    }
    #img-menu.show { display: block; }
    #img-menu .menu-section {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    #img-menu .menu-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    #img-menu .menu-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
    }
    #img-menu button {
      padding: 6px 12px;
      margin: 2px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 12px;
    }
    #img-menu button:hover { background: #e0e0e0; }
    #img-menu button.active {
      background: #7aaa6d;
      color: white;
      border-color: #5a8f4e;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Image Options Menu -->
  <div id="img-menu">
    <div class="menu-section">
      <div class="menu-label">Size</div>
      <button data-size="small">Small</button>
      <button data-size="medium">Medium</button>
      <button data-size="large">Large</button>
    </div>
    <div class="menu-section">
      <div class="menu-label">Text Wrap</div>
      <button data-float="left">← Left</button>
      <button data-float="none">None</button>
      <button data-float="right">Right →</button>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4">
      <h1 class="text-2xl font-bold text-primary mb-6 text-center">Admin Login</h1>
      <form onsubmit="checkPassword(event)">
        <input type="password" id="password-input" placeholder="Enter password"
          class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-primary focus:border-transparent">
        <button type="submit" class="w-full bg-primary hover:bg-accent text-white font-bold py-3 px-6 rounded-lg transition">
          Login
        </button>
        <p id="login-error" class="text-red-500 text-sm mt-3 text-center hidden">Incorrect password</p>
      </form>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="admin-dashboard" class="hidden">
    <header class="bg-primary text-white py-4 px-6 shadow-md">
      <div class="max-w-6xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold">Blog Admin</h1>
        <div class="flex gap-4">
          <a href="index.html" class="text-white/80 hover:text-white text-sm">View Site</a>
          <button onclick="logout()" class="text-white/80 hover:text-white text-sm">Logout</button>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto py-8 px-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Post Editor -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4" id="editor-title">New Post</h2>

            <input type="hidden" id="edit-post-id" value="">

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                <input type="text" id="post-title" placeholder="Enter post title"
                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Featured Image URL</label>
                <input type="text" id="post-image" placeholder="https://example.com/image.jpg"
                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                <p class="text-xs text-gray-500 mt-1">Paste an image URL or leave blank</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Content *</label>
                <div id="editor" class="bg-white"></div>
              </div>

              <div class="flex gap-3 pt-4">
                <button onclick="savePost()" class="bg-primary hover:bg-accent text-white font-bold py-2 px-6 rounded-lg transition">
                  Save Post
                </button>
                <button onclick="clearEditor()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg transition">
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Posts List -->
        <div>
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Posts</h2>
            <div id="posts-list" class="space-y-3">
              <!-- Posts will be listed here -->
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    const ADMIN_PASSWORD = 'jeff2024';
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyEAW8uHvs2FfyzJZ153i854RATF-As9TWKdzNVrLKBQb8CyhfRFO1_VfCro9dLd-s/exec';

    let quill;
    let postsCache = [];

    // Check if already logged in
    if (localStorage.getItem('adminLoggedIn') === 'true') {
      showDashboard();
    }

    function checkPassword(e) {
      e.preventDefault();
      const input = document.getElementById('password-input').value;
      if (input === ADMIN_PASSWORD) {
        localStorage.setItem('adminLoggedIn', 'true');
        showDashboard();
      } else {
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    function showDashboard() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('admin-dashboard').classList.remove('hidden');
      initEditor();
      loadPosts();
    }

    function logout() {
      localStorage.removeItem('adminLoggedIn');
      location.reload();
    }

    function initEditor() {
      quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link', 'image'],
            ['clean']
          ]
        },
        placeholder: 'Write your blog post here...'
      });

      // Override image button to prompt for URL instead of file upload
      var toolbar = quill.getModule('toolbar');
      toolbar.addHandler('image', function() {
        var url = prompt('Enter image URL:');
        if (url) {
          var range = quill.getSelection();
          quill.insertEmbed(range ? range.index : 0, 'image', url);
        }
      });

      // Image menu handling
      var imgMenu = document.getElementById('img-menu');
      var selectedImg = null;

      // Show menu on image click
      quill.root.addEventListener('click', function(e) {
        if (e.target.tagName === 'IMG') {
          e.preventDefault();
          selectedImg = e.target;

          // Position menu near the image
          var rect = e.target.getBoundingClientRect();
          imgMenu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
          imgMenu.style.left = (rect.left + window.scrollX) + 'px';
          imgMenu.classList.add('show');

          // Update active buttons
          updateMenuButtons();
        }
      });

      // Hide menu when clicking elsewhere
      document.addEventListener('click', function(e) {
        if (!imgMenu.contains(e.target) && e.target.tagName !== 'IMG') {
          imgMenu.classList.remove('show');
          selectedImg = null;
        }
      });

      // Handle menu button clicks
      imgMenu.addEventListener('click', function(e) {
        if (!selectedImg || e.target.tagName !== 'BUTTON') return;

        var size = e.target.dataset.size;
        var float = e.target.dataset.float;

        if (size) {
          selectedImg.classList.remove('small', 'medium');
          if (size !== 'large') selectedImg.classList.add(size);
        }

        if (float) {
          selectedImg.classList.remove('float-left', 'float-right');
          if (float === 'left') selectedImg.classList.add('float-left');
          if (float === 'right') selectedImg.classList.add('float-right');
        }

        updateMenuButtons();
      });

      function updateMenuButtons() {
        if (!selectedImg) return;

        // Update size buttons
        imgMenu.querySelectorAll('[data-size]').forEach(function(btn) {
          var size = btn.dataset.size;
          var isActive = (size === 'large' && !selectedImg.classList.contains('small') && !selectedImg.classList.contains('medium'))
            || selectedImg.classList.contains(size);
          btn.classList.toggle('active', isActive);
        });

        // Update float buttons
        imgMenu.querySelectorAll('[data-float]').forEach(function(btn) {
          var float = btn.dataset.float;
          var isActive = (float === 'none' && !selectedImg.classList.contains('float-left') && !selectedImg.classList.contains('float-right'))
            || (float === 'left' && selectedImg.classList.contains('float-left'))
            || (float === 'right' && selectedImg.classList.contains('float-right'));
          btn.classList.toggle('active', isActive);
        });
      }
    }

    async function loadPosts() {
      const listEl = document.getElementById('posts-list');
      listEl.innerHTML = '<p class="text-gray-500 text-sm">Loading...</p>';

      try {
        const response = await fetch(GOOGLE_SCRIPT_URL);
        postsCache = await response.json();

        if (postsCache.length === 0) {
          listEl.innerHTML = '<p class="text-gray-500 text-sm">No posts yet</p>';
          return;
        }

        listEl.innerHTML = postsCache.map(post => `
          <div class="border border-gray-200 rounded-lg p-3">
            <h3 class="font-semibold text-gray-800 text-sm truncate">${post.title}</h3>
            <p class="text-xs text-gray-500 mt-1">${new Date(post.date).toLocaleDateString()}</p>
            <div class="flex gap-2 mt-2">
              <button onclick="editPost('${post.id}')" class="text-xs text-primary hover:text-accent">Edit</button>
              <button onclick="deletePost('${post.id}')" class="text-xs text-red-500 hover:text-red-700">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading posts:', error);
        listEl.innerHTML = '<p class="text-red-500 text-sm">Error loading posts</p>';
      }
    }

    async function savePost() {
      const title = document.getElementById('post-title').value.trim();
      const image = document.getElementById('post-image').value.trim();
      const content = quill.root.innerHTML;
      const editId = document.getElementById('edit-post-id').value;

      if (!title) {
        alert('Please enter a title');
        return;
      }

      if (quill.getText().trim().length < 10) {
        alert('Please enter some content');
        return;
      }

      const postData = {
        type: 'blog',
        action: 'save',
        title,
        image,
        content,
        updated: new Date().toISOString()
      };

      if (editId) {
        postData.editId = editId;
      } else {
        postData.id = 'post_' + Date.now();
        postData.date = new Date().toISOString();
      }

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData)
        });

        // Don't clear yet - wait and verify the post was saved
        alert('Saving... Please wait while we verify.');

        // Wait for Google Sheets to process, then check if it saved
        setTimeout(async () => {
          await loadPosts();
          const savedPost = postsCache.find(p => p.id === postData.id || p.id === postData.editId);
          if (savedPost) {
            clearEditor();
            alert('Post saved successfully!');
          } else {
            alert('Warning: Post may not have saved. Your content is still in the editor. Please check your Apps Script in Google Sheets.');
          }
        }, 2000);
      } catch (error) {
        console.error('Error saving post:', error);
        alert('Error saving post. Please try again.');
      }
    }

    function editPost(id) {
      const post = postsCache.find(p => p.id === id);
      if (!post) return;

      document.getElementById('post-title').value = post.title;
      document.getElementById('post-image').value = post.image || '';
      quill.root.innerHTML = post.content;
      document.getElementById('edit-post-id').value = id;
      document.getElementById('editor-title').textContent = 'Edit Post';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deletePost(id) {
      if (!confirm('Are you sure you want to delete this post?')) return;

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: 'blog', action: 'delete', id })
        });

        // Clear editor if we were editing this post
        if (document.getElementById('edit-post-id').value === id) {
          clearEditor();
        }

        // Wait a moment for Google Sheets to process
        setTimeout(loadPosts, 1000);
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('Error deleting post. Please try again.');
      }
    }

    function clearEditor() {
      document.getElementById('post-title').value = '';
      document.getElementById('post-image').value = '';
      quill.root.innerHTML = '';
      document.getElementById('edit-post-id').value = '';
      document.getElementById('editor-title').textContent = 'New Post';
    }
  </script>
</body>
</html>
